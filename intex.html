<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
    <title>Document</title>
</head>
<style>
    
</style>
<body>
    <div class="container">
        <header class="row">
            <h1 class="col-12 text-center">Total <span class="js-compteur badge bg-dark"></span></h1>
        </header>
        <hr>
            <div class="row">
                <div class="col-6 text-center">
                    <h3>Dépenses</h3>
                    <div class="row">
                        <p class="text-center" id="depenses"></p>
                    </div>
                </div>
                <div class="col-6 text-center">
                    <h3>Recettes</h3>
                    <div class="row">
                        <p class="text-center" id="recettes"></p>
                    </div>
                </div>
            </div>
        <hr>
        <section class="row">
            <h2>Détails</h2>
            <!-- <div class="js-list-tache"> -->
                <table class="table">
                    <thead>
                      <tr>
                        <th scope="col">id</th>
                        <th scope="col">Nom</th>
                        <th scope="col">Montant</th>
                        <th scope="col">Action</th>
                      </tr>
                    </thead>
                    <tbody class="js-list">
                      
                    </tbody>
                  </table>
            <!-- </div> -->
        </section>
        <hr>
        <section class="row">
            <h2 class="mb-3">Ajouter une nouvelle dépense / Recette</h2>
            <form class="d-flex js-form-add">
                <input type="text" required name="name" class="form-input mx-3" style="flex-grow:1" placeholder="Nom">
                <input type="number" required name="montant" id="montant" class="form-input mx-3" style="flex-grow:1" placeholder="Montant">
                <button class="btn btn-success ms-4">
                    Envoyer
                </button>
            </form>
        </section>
    </div>
</body>
<script>
    window.addEventListener("DOMContentLoaded"  , async() => {
        const reponse = await fetch("http://localhost:4221/depenses" )
        const depenses = await reponse.json(); 
        
        //
        document.querySelector(".js-list").innerHTML = genererForms(depenses);

        // Affichage compteur
        const total = getTotal(depenses);
        const compteur = document.querySelector(".js-compteur");
        const total_recettes = getRecettes(depenses);
        const total_depenses = getDepenses(depenses);
        document.querySelector("#recettes").innerHTML = total_recettes
        document.querySelector("#depenses").innerHTML = total_depenses

        if(total > 0){
            compteur.classList.remove("bg-dark")
            compteur.classList.remove("bg-warning")
            compteur.classList.add("bg-success")
        }else{
            compteur.classList.remove("bg-dark")
            compteur.classList.remove("bg-success")
            compteur.classList.add("bg-warning")
        }
        compteur.innerHTML = getTotal(depenses);
        
       

        //Modification de la list
        document.querySelector(".js-list").addEventListener("click" , async e => {
            e.preventDefault();
            if(e.target.className.includes("btn")){
                const form = e.target.parentNode.parentNode.childNodes;
                const action = e.target.value ;
                const id = form[1].innerHTML;
                const name = form[3].children[0].value == "" ? "Default_"+id : form[3].children[0].value;
                const value = Number.isNaN(parseInt(form[5].children[0].value)) ? 0 : parseInt(form[5].children[0].value);

                if(action == "modifier"){
                    const data = {
                        id : id,
                        name : name,
                        value : value
                    }
                    const options = { method : "PUT" , body : JSON.stringify(data) , headers : {'Content-Type': 'application/json'} }
                    await fetch("http://localhost:4221/depenses/"+id , options)
                }else if(action == "supprimer"){
                    const options = {method : "DELETE"}
                    await fetch("http://localhost:4221/depenses/"+id , options);
                }
            }
        })



        document.querySelector(".js-form-add").addEventListener("submit" , async (e) => {
            e.preventDefault();
            const data = {
                name : e.target.name.value ,
                value : e.target.montant.value 
            }
            // vérification avec joi 

            const optionsRequete = { method : "POST" , body : JSON.stringify(data) , headers :  {'Content-Type': 'application/json'}  }
            const reponse = await fetch("http://localhost:4221/depenses" , optionsRequete)

            if(reponse.status) e.target.reset()

        })
        function genererForms(data){

            if(data.length === 0) return "<p class='mt-3'>Veuillez ajouter une dépense / recette</p>";

            return data.map( d => {
                return `<tr>
                        <th name="id" scope="row">${d.id}</th>
                        
                        <td><input type="text" required style="border-width:0px" name="name" class="form-input" value="${d.name}"></td>
                        <td><input type="number" required name="value" style="border-width:0px" class="form-input" value="${d.value}"></td>
                        <td>
                            <input type="submit" class="btn btn-primary mx-3" value="modifier">
                            <input type="submit" class="btn btn-danger" value="supprimer">
                        </td>
                      </tr> 
                                     
                `
            }).join("")
        }

        function getTotal(depenses){
            let total = 0;
            depenses.map(item=>{
                total += parseInt(item.value)
            })
            return total;
        }
        function getRecettes(depenses){
            let total = 0;
            depenses.map(item=>{
                if(parseInt(item.value) > 0)
                    total += parseInt(item.value)
            })
            return total;
        }
        function getDepenses(depenses){
            let total = 0;
            depenses.map(item=>{
                if(parseInt(item.value) < 0)
                    total += parseInt(item.value)
            })
            return total;
        }

    })
    
</script>
</html>